<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Add polygons to a map using a GeoJSON source</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.js"></script>
<style>
body { margin: 0; padding: 0; }
#map { position: absolute; top: 0; bottom: 0; width: 100%; }
</style>
</head>
<body>
<div id="map"></div>
<script>
const accessToken = 'pk.eyJ1Ijoic2VyZ2Fubm4iLCJhIjoiY2w2NWw0ejZ3MDdmZDNpbm84eWtqOWx0cSJ9.KdhQrNoti2fgGSRSqDiyHQ';
async function initMap() {
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/standard',
        center: [30.3352, 59.9346], // Default center
        zoom: 12,
        accessToken: accessToken
    });

    await map.on('load', async () => {
        try {
            const boundaryResponse = await fetch(`
             https://api.geoapify.com/v2/place-details?id=5100af3bb953553e405988c2c2a453f94d40f00101f901cc9f8f0000000000c00205920323486973746f7269632043656e747265206f66205361696e742d50657465727362757267&features=details,details.names&apiKey=b8568cb9afc64fad861a69edbddb2658`);
           // https://api.geoapify.com/v2/place-details?id=51fa0b3d62f4503e4059b6dac35e28f84d40f00101f9018f6c060000000000c002089203105361696e742050657465727362757267&apiKey=b8568cb9afc64fad861a69edbddb2658');
           
            const boundaryData = await boundaryResponse.json();
            const response = await fetch("/test/maps.php", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(boundaryData)
            });

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            
            const data = await response.json();

            const polygons = [];
            for (let i = 0; i < data.length; i++) {
                const polygon = data[i].map(point => [point.lat, point.long]);
                polygons.push(polygon);
            }

            const lastPolygon = polygons[polygons.length - 1];
            const lastPoint = lastPolygon[0]; // Assuming the first point is the center
            
            // Calculate the center of the polygon
            let centerX = 0;
            let centerY = 0;
            for (let i = 0; i < lastPolygon.length; i++) {
                centerX += lastPolygon[i][0];
                centerY += lastPolygon[i][1];
            }
            centerX /= lastPolygon.length;
            centerY /= lastPolygon.length;

            // Set the map center and zoom level
            map.setCenter([centerX, centerY]);
            map.setZoom(15); // Adjust this value as needed

            map.addSource('polygons', {
                'type': 'geojson',
                'data': {
                    'type': 'FeatureCollection',
                    'features': []
                }
            });
            map.addSource('polygons2', {
                'type': 'geojson',
                'data': {
                    'type': 'FeatureCollection',
                    'features': []
                }
            });
            map.addLayer({
                'id': 'polygons2',
                'type': 'fill',
                'source': 'polygons2',
                'layout': {},
                'paint': {
                    'fill-color': 'gray',
                    'fill-opacity': 0.5
                }
            });
            map.addLayer({
                'id': 'polygons',
                'type': 'line',
                'source': 'polygons',
                'layout': {},
                'paint': {
                    'fill-color': '#0080ff',
                    'fill-opacity': 0.5
                }
            });

            const features = polygons.map((polygon) => ({
                type: 'Feature',
                geometry: {
                    type: 'Polygon',
                    coordinates: [polygon]
                }
            }));

            map.getSource('polygons').setData({
                type: 'FeatureCollection',
                features: features
            });
            map.getSource('polygons2').setData(boundaryData);
            console.log('Boundary data successfully added to source');
            window.sermap = map;

        } catch (error) {
            console.error('Error initializing map:', error);
        }
    });
}


window.onload = initMap;
</script>
</body>
</html>
